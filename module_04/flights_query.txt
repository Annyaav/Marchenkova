with flights as (-- таблица с рейсами из Анапы (базовая?)  SELECT flight_id, flight_no, city_dep.city as dep_city, city_arr.city as arr_city, aircrafts.model, f.aircraft_code, scheduled_departure,         date_part('hour', scheduled_arrival - scheduled_departure) * 60 + date_part('minute', scheduled_arrival - scheduled_departure) as duration, /*длительность перелета расписание*/        date_part('hour', actual_arrival - actual_departure) * 60 + date_part('minute', actual_arrival - actual_departure) as duration_actual /*длитеьность перелета факт*/  FROM dst_project.flights as f  inner join dst_project.airports as city_dep --получаем город вылета    on f.departure_airport=city_dep.airport_code  inner join dst_project.airports as city_arr -- получаем город прилета    on f.arrival_airport=city_arr.airport_code  inner join dst_project.aircrafts as aircrafts -- Получаем модель воздушного судна    on f.aircraft_code=aircrafts.aircraft_code    WHERE departure_airport = 'AAQ'  AND (date_trunc('month', scheduled_departure) in ('2016-12-01','2017-02-01','2017-02-01', '2017-12-01'))  AND status not in ('Cancelled')  ),  -- Общее количество посадочных мест в самолете (не в модели, а конкретном самолете на конкретном рейсе)seats_class as(with cnt_total as (with seats_count as (  select aircraft_code, 'total_number' as ztype_val, count(seat_no) as cnt    from dst_project.seats    group by aircraft_code, ztype_val  union all-- количество мест каждого класса  select aircraft_code, fare_conditions as  ztype_val, count(seat_no) as cnt    from dst_project.seats    group by aircraft_code, ztype_val    order by aircraft_code, ztype_val)select aircraft_code,    case        when seats_count.ztype_val like 'Business'  then cnt    end as business,    case         when seats_count.ztype_val like 'Comfort'  then cnt    end as comfort,    case         when seats_count.ztype_val like 'Economy'  then cnt    end as economy,    case         when seats_count.ztype_val like 'total_number'  then cnt    end as total_number    from seats_count)select aircraft_code, sum(business) as buisness_class, sum(comfort) as comfort_class, sum(economy) as economy_class, sum (total_number) as total_seats from cnt_totalgroup by aircraft_code)-- итоговый запросselect flights.flight_id, flight_no, dep_city, arr_city, model, buisness_class, /*comfort_class не учитываем, т.к. из анапы нет рейсов с этим классом*/ economy_class, total_seats, duration, duration_actual,        sum (amount) /*сумма за проданные билеты*/ as flihgt_amount, sum (amount)/total_seats /*суума за билеты к общему количеству мест в самолете*/ as udel_amount,         count (ticket_no) /*количество проданных билетов на рейс*/, count (ticket_no)/total_seats as zapoln /*заполненность самолета (востребованность рейса)*/,        date_part ('hour', scheduled_departure) as sheduled_hour, date_part ('minute', scheduled_departure) as sheduled_min, EXTRACT(DOW FROM scheduled_departure) as DOW,        case           when model like '%737-300%'  then 40*duration/1000          when model like '%100%'  then 28.3*duration/1000        end as rashod_topliva, -- добавляем колонку с нормативным расходом топлива * время в полете в зависимости от модели самолета, переводим в тонны (данные из Вики)        case           when date_part('year', scheduled_departure) = 2016 and date_part('month', scheduled_departure) = 12 then 38867 -- цена в Анапе в декабре 2016          when date_part('year', scheduled_departure) = 2017 and date_part('month', scheduled_departure) = 1 then 41435 -- цена в Анапе в январе 2017          when date_part('year', scheduled_departure) = 2017 and date_part('month', scheduled_departure) = 2 then 39553 -- цена в Анапе в феврале 2017          when date_part('year', scheduled_departure) = 2017 and date_part('month', scheduled_departure) = 12 then 47101 -- цена в Анапе в декабре 2017        end as fuel_pricefrom flightsleft join seats_class on flights.aircraft_code=seats_class.aircraft_codeleft join dst_project.ticket_flights as t on flights.flight_id=t.flight_id -- Стоимость билетов на рейсе по flight_idgroup by flights.flight_id, flight_no, dep_city, arr_city, model, buisness_class, comfort_class, economy_class, total_seats, duration, duration_actual,        date_part ('hour', scheduled_departure), date_part ('minute', scheduled_departure), DOW, rashod_topliva, fuel_priceorder by flights.flight_id